{% extends "base.html" %}
{% block title %}Home{% endblock %}
{% block content %}
<div id="app" style="width: 80%; padding: 20px;">
    <div v-for="p in posts" class="div_content_style">
        [[ p.pk ]]
    </div>
</div>
<script>
    const { createApp, ref, onMounted } = Vue
  
    createApp({
      delimiters: ['[[',']]'],  
      setup() {
        const posts = ref([])
        const postlikes = ref([]);
        const postcomments = ref([]);
        const useratributes = ref([]);
        const commenttxt = ref('');
        const initialState = ref(false)
        
        onMounted(() => {
            if(!initialState.value){
                axios.get("postlist").then((data) => {      
                    posts.value = data.data;
                    console.log(posts.value)
                    let postids = data.data.map(i => {return i.fields.user})
                    let ids_of_posts = String(postids.filter(onlyUnique))
                    loadUserAtrib(ids_of_posts);
                });    
                initialState.value = true     
            }
            getData("postlikes");
            getData("postcomments");
        })
        function search(k, arr) {
            return arr[k] || 0
        };
        function onlyUnique(value, index, array) {
            return array.indexOf(value) === index;
        };
        async function loadUserAtrib(ids_of_posts) {
            await axios.get('/useratrib/', { params: { ids: ids_of_posts } }).then((data) => {
               var arr = {};
               let v = data.data.split(';')
               for (var i = 0; i < v.length; i++) {
                    var s = v[i].split(':');
                    if(s[0] === null || s[0] === '' || s[0] === 'null' || typeof s[0] === 'undefined') {
                        break;
                    }
                    arr[s[0].trim()] = s[1].trim();
                }
                useratributes.value = arr
                console.log('User: ' + useratributes.value)
            })
        }

        async function getData(pg) {
           //setCountPostClick(countPostClick + 1)
           await axios.get(pg).then((data) => {
               var arr = {};
               let v = data.data.split(';')
               for (var i = 0; i < v.length; i++) {
                    var s = v[i].split(':');
                    if(s[0] === null || s[0] === '' || s[0] === 'null' || typeof s[0] === 'undefined') {
                        break;
                    }
                    arr[s[0].trim()] = s[1].trim();
                }
                if(pg === "postlikes") {
                   postlikes.value = arr;                    
                }
                else if(pg === "postcomments") {
                    postcomments.value = arr; 
                }
                
            })
        };
        async function sendData(vtype_of_like, vpost_id) {
            let rs_response = ""
            let link = ""

            if(vtype_of_like === "like") {
                link = "/addremovelike/" 
            } else if(vtype_of_like === "comment") {
                link = "/addcomment/"
            }
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const v = {"post_id": vpost_id, "type_of_like": vtype_of_like, "txt": commenttxt }            
            await axios.post(link, v, 
                {
                    headers: {
                        'X-CSRFToken': csrftoken
                    }
                })
                .then((response) => {
                    rs_response = response.data
                    console.log("rs: " + rs_response)
                    if(vtype_of_like === "like") {
                       getData("postlikes"); 
                    } else if(vtype_of_like === "comment") {
                       getData("postcomments");
                    }    
                }, (error) => {
                    rs_response = error;
                });
        }

        //const countPostClick = ref(0)
        return {
            posts,
            postlikes,
            postcomments,
            useratributes,
            commenttxt,
            initialState
        }
      }
    }).mount('#app')
  </script>
{% endblock content %}